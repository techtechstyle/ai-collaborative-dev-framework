# T5: 損切りルール＋復帰フローのBPMN要素分解

> **タスク**: 損切りルール（撤退判断）および損切り後の復帰フローを、BPMN要素に対応付ける
> **検証方法**: 損切りルール・復帰フローの全ステップがBPMN要素に対応していること
> **自信度**: 確実（プロジェクトドキュメントからの直接抽出・変換）
> **入力**: `03-practices.md`（§14. 損切りライン、損切り後の復帰フロー、エスカレーション基準）、`phase1-t3-bpmn-elements.md`（SP-3概要、RF概要）、`phase1-t2-dmn-decision-tables.md`（DT-8, DT-9）

---

## T3との関係

T3では以下の2箇所を「概要のみ」または「サブプロセス内の一部」として記載していた。T5ではこれらを正式にBPMN要素として詳細分解する。

| T3での記載 | T5での分解対象 |
|-----------|---------------|
| SP-3 内の SP3-GW4（損切り判定） | → §1. 損切り判断サブプロセスとして独立分解 |
| §5. 復帰フロー（概要5要素のみ） | → §2. 復帰フローとして正式分解 |
| （記載なし） | → §3. エスカレーション判断サブプロセスを新規追加 |

**T3で確定済みの要素IDとの整合性:**
- T3の SP3-GW4, SP3-IE1, SP3-IE2, SP3-EE-NG はそのまま維持
- T3の RF-SE, RF-T1, RF-GW1, RF-T2, RF-EE はT5で詳細化（IDを拡張）

---

## 使用するBPMN要素の凡例

| BPMN要素 | 記号 | 用途 |
|----------|------|------|
| **開始イベント** | ○ | フローの開始点 |
| **終了イベント** | ◎ | フローの終了点 |
| **タスク** | □ | 具体的な作業・処理 |
| **サブプロセス** | □⊞ | 内部に詳細フローを持つ複合タスク |
| **排他ゲートウェイ (XOR)** | ◇ | 条件分岐（1つの経路のみ選択） |
| **中間イベント（エラー）** | ○! | エラー検知イベント |
| **中間イベント（タイマー）** | ○⏱ | 時間条件イベント |
| **データオブジェクト** | 📄 | フロー内で参照・生成される成果物 |

---

## 1. 損切り判断サブプロセス（SP3-GW4 の詳細分解）

> **出典**: `03-practices.md`（損切りライン：撤退ルール）
> **位置**: メインフロー SP-3（検証フィードバックループ）内、検証失敗時に起動

### 1.1 全体の位置づけ

T3のSP-3フローにおいて、typecheck/lint/testのいずれかが失敗した場合、SP3-GW4（損切り判定）が起動される。T5ではこのSP3-GW4を「損切り判断サブプロセス」として詳細分解する。

```
（T3 SP-3フローからの接続）
SP3-GW1/GW2/GW3 --[失敗]-→ 【LC: 損切り判断サブプロセス（本セクション）】
SP3-IE1（30分経過）→ 【LC: 強制起動】
SP3-IE2（同一エラー3回目）→ 【LC: 強制起動】
```

### 1.2 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 |
|--------|----------|------|---------------|
| **LC-SE** | 開始イベント | 損切り判断開始 | SP3-GW1〜GW3の失敗、またはIE1/IE2からの遷移 |
| **LC-T1** | タスク | エラー状態を記録する | 失敗回数・経過時間・コード複雑度の現在値を取得 |
| **LC-GW1** | 排他ゲートウェイ (XOR) | 3回ルール判定 | 「🚨 3回ルール」: 同じエラーに3往復 |
| **LC-GW2** | 排他ゲートウェイ (XOR) | 時間ルール判定 | 「🚨 時間ルール」: 30分以上経過 |
| **LC-GW3** | 排他ゲートウェイ (XOR) | 複雑化ルール判定 | 「🚨 複雑化ルール」: 修正のたびに複雑化 |
| **LC-GW4** | 排他ゲートウェイ (XOR) | 再発ルール判定 | 「同じエラーが再発」: 以前解決済みのエラーが再度発生 |
| **LC-T2** | タスク | エラーの修正を指示する | T3の SP3-T4 と同一（再検証ループへ戻る） |
| **LC-EE-CONT** | 終了イベント | 修正継続（SP3-T1に戻る） | 損切り条件に該当しない場合 |
| **LC-EE-CUT** | 終了イベント | 損切り確定（復帰フローへ） | 損切り条件のいずれかに該当した場合 |

### 1.3 フロー接続関係

```
LC-SE → LC-T1 → LC-GW1
  LC-GW1 --[3往復以上]-→ LC-EE-CUT
  LC-GW1 --[3往復未満]-→ LC-GW2
    LC-GW2 --[30分超過]-→ LC-EE-CUT
    LC-GW2 --[30分未満]-→ LC-GW3
      LC-GW3 --[複雑化している]-→ LC-EE-CUT
      LC-GW3 --[複雑化していない]-→ LC-GW4
        LC-GW4 --[再発している]-→ LC-EE-CUT
        LC-GW4 --[再発していない]-→ LC-T2 → LC-EE-CONT
```

### 1.4 各ゲートウェイの判定条件

| ゲートウェイID | 判定条件 | 閾値 | 判定種別 | 出典 |
|-------------|---------|------|---------|------|
| LC-GW1 | 同一エラーへの往復回数 | ≥ 3往復 | 定量判断 | 「🚨 3回ルール」 |
| LC-GW2 | 1つのエラー対応に要した時間 | ≥ 30分 | 定量判断 | 「🚨 時間ルール」 |
| LC-GW3 | 修正のたびにコードが複雑化しているか | 定性判断 | 定性判断 | 「🚨 複雑化ルール」 |
| LC-GW4 | 以前解決済みのエラーが再発しているか | 定性判断 | 定性判断 | 「同じエラーが再発」 |

### 1.5 入出力

| 要素ID | 入力 | 出力 |
|--------|------|------|
| LC-T1 | 検証失敗の情報（エラー内容、発生時刻） | エラー状態記録（回数、経過時間、複雑度変化） |
| LC-T2 | エラー内容、過去の修正履歴 | 修正指示（AI/人間への具体的指示） |

---

## 2. 損切り後の復帰フロー（正式分解）

> **出典**: `03-practices.md`（損切り後の復帰フロー、アプローチ選択の判断基準、復帰フロー実践例）
> **位置**: LC-EE-CUT（損切り確定）から遷移

### 2.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 |
|--------|----------|------|---------------|
| **RF-SE** | 開始イベント | 損切り発生（復帰フロー開始） | LC-EE-CUT からの遷移 |
| **RF-T1** | タスク | 問題を言語化する | Step 1: 「何が起きたかを言語化する」 |
| **RF-T2** | タスク | 原因を分析する | Step 1: 「なぜ解決できなかったかを考える」 |
| **RF-T3** | タスク | 問題の本質を特定する | Step 1: 「問題の本質を特定する」 |
| **RF-GW1** | 排他ゲートウェイ (XOR) | エスカレーション必要性判定 | エスカレーション基準（即座/30分以内） |
| **RF-SP1** | サブプロセス | エスカレーション判断 | エスカレーション基準（詳細は§3） |
| **RF-GW2** | 排他ゲートウェイ (XOR) | アプローチ選択 | Step 2: A/B/C/Dの選択 |
| **RF-T4** | タスク | A: 人間が直接解決する | 「自分でコードを書く」 |
| **RF-T5** | タスク | A: AIに解説を依頼する | 「動いたらClaudeに『なぜ動くか解説して』と依頼」 |
| **RF-T6** | タスク | B: 問題を再分解する | 「より小さなタスクに分割」 |
| **RF-T7** | タスク | C: コンテキストをリセットする | 「新しいセッションを開始」 |
| **RF-T8** | タスク | D: チームメンバーに相談する | 「ペアプログラミングで解決」 |
| **RF-T9** | タスク | CLAUDE.mdに失敗パターンを追記する | Step 3: 「学びの記録（必須）」 |
| **RF-T10** | タスク | 次回の回避策を明記する | Step 3: 「次回の回避策を明記」 |
| **RF-GW3** | 排他ゲートウェイ (XOR) | チーム共有が必要か？ | Step 3: 「チームで共有（該当する場合）」 |
| **RF-T11** | タスク | チームに共有する | Step 3: 「チームで共有」 |
| **RF-EE** | 終了イベント | メインフロー SE-1 に戻る | 再挑戦（分解後タスクで再実行） |

### 2.2 フロー接続関係

```
RF-SE → RF-T1 → RF-T2 → RF-T3 → RF-GW1
  RF-GW1 --[即座にエスカレーション必要]-→ RF-SP1 → RF-T8 → RF-T9 → RF-T10 → RF-GW3
  RF-GW1 --[エスカレーション不要]-----→ RF-GW2
    RF-GW2 --[A: 自分で解法がわかる]---→ RF-T4 → RF-T5 → RF-T9 → RF-T10 → RF-GW3
    RF-GW2 --[B: タスクが大きすぎた]---→ RF-T6 → RF-T9 → RF-T10 → RF-GW3
    RF-GW2 --[C: コンテキスト汚染]-----→ RF-T7 → RF-T9 → RF-T10 → RF-GW3
    RF-GW2 --[D: 自分では判断できない]-→ RF-SP1 → RF-T8 → RF-T9 → RF-T10 → RF-GW3
  RF-GW3 --[チーム共有が必要]-→ RF-T11 → RF-EE
  RF-GW3 --[個人で完結]------→ RF-EE
```

### 2.3 Step 1（問題の分析）の詳細

| タスクID | 入力 | 処理 | 出力 | 所要時間目安 |
|---------|------|------|------|------------|
| RF-T1 | エラー情報、修正履歴 | 何が起きたかを自然言語で記述 | 問題記述文 | 1-2分 |
| RF-T2 | 問題記述文 | なぜ解決できなかったかを分析 | 原因仮説リスト | 2-3分 |
| RF-T3 | 原因仮説リスト | 仮説から本質的な原因を絞り込む | 本質的原因（1文） | 2-5分 |

**所要時間合計**: 5-10分（出典に「5-10分」と明記）

### 2.4 Step 2（アプローチ選択）の判断基準

| 条件 | 推奨アプローチ | RF-GW2の分岐先 | 理由 |
|------|---------------|---------------|------|
| 自分で解法がわかる | A: 人間が直接解決 | RF-T4 | 最速で解決、学びも得られる |
| タスクが大きすぎた | B: 問題を再分解 | RF-T6 | 根本原因に対処 |
| コンテキストが汚染されている | C: リセット | RF-T7 | 新鮮な状態で再開 |
| 自分では判断できない | D: エスカレーション | RF-SP1 | 一人で抱えない |

### 2.5 Step 3（学びの記録）の詳細

| タスクID | 入力 | 処理 | 出力 |
|---------|------|------|------|
| RF-T9 | 問題の本質、選択したアプローチ、解決結果 | CLAUDE.mdの禁止事項/注意事項に失敗パターンを追記 | 更新されたCLAUDE.md（D-1） |
| RF-T10 | 失敗パターン | 「次回どうすれば回避できるか」を具体的に記述 | 回避策記述（D-5に追記） |
| RF-T11 | 失敗パターン、回避策 | チーム内で共有（日次/週次ミーティング等） | 共有記録 |

**重要**: RF-T9（CLAUDE.mdへの記録）は**必須ステップ**。出典に「必須」と明記されている。省略は許可されない。

---

## 3. エスカレーション判断サブプロセス（RF-SP1 の詳細分解）

> **出典**: `03-practices.md`（エスカレーション基準）

### 3.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 |
|--------|----------|------|---------------|
| **ES-SE** | 開始イベント | エスカレーション判断開始 | — |
| **ES-GW1** | 排他ゲートウェイ (XOR) | 即座にエスカレーションが必要か？ | 「🚨 即座にエスカレーション」 |
| **ES-GW2** | 排他ゲートウェイ (XOR) | 30分以内にエスカレーション検討すべきか？ | 「⚠️ 30分以内にエスカレーション検討」 |
| **ES-T1** | タスク | 即座にエスカレーションを実施する | セキュリティ/本番影響/データ損失時 |
| **ES-T2** | タスク | 30分以内にエスカレーションを検討する | 3回撤退/原因不明/スキル範囲外時 |
| **ES-EE-ESC** | 終了イベント | エスカレーション実施 | チームメンバーへの相談へ |
| **ES-EE-SELF** | 終了イベント | 自力で対応（RF-GW2に戻る） | エスカレーション不要と判断 |

### 3.2 フロー接続関係

```
ES-SE → ES-GW1
  ES-GW1 --[即座に必要（セキュリティ/本番影響/データ損失）]-→ ES-T1 → ES-EE-ESC
  ES-GW1 --[即座には不要]-→ ES-GW2
    ES-GW2 --[検討すべき（3回撤退/原因不明/スキル範囲外）]-→ ES-T2 → ES-EE-ESC
    ES-GW2 --[不要]-→ ES-EE-SELF
```

### 3.3 エスカレーション判定条件

| 緊急度 | 条件 | ゲートウェイ | アクション |
|-------|------|------------|----------|
| 🚨 即座 | セキュリティに関わる問題 | ES-GW1 | 即座にエスカレーション |
| 🚨 即座 | 本番環境に影響する可能性がある | ES-GW1 | 即座にエスカレーション |
| 🚨 即座 | データ損失のリスクがある | ES-GW1 | 即座にエスカレーション |
| ⚠️ 30分以内 | 同じエラーで3回撤退した | ES-GW2 | エスカレーション検討 |
| ⚠️ 30分以内 | 問題の原因が全くわからない | ES-GW2 | エスカレーション検討 |
| ⚠️ 30分以内 | 自分のスキル範囲外と感じる | ES-GW2 | エスカレーション検討 |
| 💡 日次/週次 | 繰り返し発生するパターン | （フロー外） | 定期共有で対応 |

---

## 4. データオブジェクト（フロー内で参照・生成される成果物）

| データID | 名称 | 生成元 | 参照先 | 備考 |
|---------|------|--------|--------|------|
| **D-1** | CLAUDE.md | RF-T9（失敗パターン追記） | メインフロー全体 | T3で定義済み。T5では更新操作を詳細化 |
| **D-5** | 失敗パターン記録 | RF-T10（回避策追記） | D-1（CLAUDE.mdに追記） | T3で定義済み |
| **D-6** | エラー状態記録 | LC-T1 | LC-GW1〜GW4（判定に使用） | T5で新規追加 |
| **D-7** | 問題分析結果 | RF-T1〜T3 | RF-GW2（アプローチ選択に使用） | T5で新規追加 |
| **D-8** | チーム共有記録 | RF-T11 | （フロー外：チームのナレッジベース） | T5で新規追加 |

---

## 5. T3フローとの接続マップ

### 5.1 T3 → T5 への遷移点

| T3の要素 | T5の接続先 | 遷移条件 |
|---------|----------|---------|
| SP3-GW1 --[失敗] | LC-SE | typecheck失敗時 |
| SP3-GW2 --[失敗] | LC-SE | lint失敗時 |
| SP3-GW3 --[失敗] | LC-SE | test失敗時 |
| SP3-IE1（30分経過） | LC-SE | タイマーイベント発火 |
| SP3-IE2（同一エラー3回目） | LC-SE | エラーイベント発火 |

### 5.2 T5 → T3 への復帰点

| T5の要素 | T3の接続先 | 復帰条件 |
|---------|----------|---------|
| LC-EE-CONT | SP3-T1（typecheck再実行） | 損切り条件に該当せず修正継続 |
| RF-EE | SE-1（メインフロー開始） | 復帰フロー完了後、再挑戦 |

### 5.3 統合フロー図（T3 SP-3 + T5）

```
【T3: SP-3 検証フィードバックループ】
SP3-SE → SP3-T1(typecheck) → SP3-GW1
  SP3-GW1 --[成功]-→ SP3-T2(lint) → SP3-GW2
    SP3-GW2 --[成功]-→ SP3-T3(test) → SP3-GW3
      SP3-GW3 --[成功]-→ SP3-EE-OK
      SP3-GW3 --[失敗]-→ 【T5: LC 損切り判断】
    SP3-GW2 --[失敗]-→ 【T5: LC 損切り判断】
  SP3-GW1 --[失敗]-→ 【T5: LC 損切り判断】

SP3-IE1(30分経過) → 【T5: LC 損切り判断】
SP3-IE2(同一エラー3回) → 【T5: LC 損切り判断】

【T5: LC 損切り判断サブプロセス】
LC-SE → LC-T1 → LC-GW1 → ... → LC-GW4
  → LC-EE-CONT → SP3-T1（修正後の再検証、T3に戻る）
  → LC-EE-CUT  → 【T5: RF 復帰フロー】

【T5: RF 復帰フロー】
RF-SE → RF-T1〜T3(問題分析) → RF-GW1(エスカレーション判定) → RF-GW2(アプローチ選択)
  → RF-T4〜T8(各アプローチ実行) → RF-T9〜T10(学び記録) → RF-GW3(チーム共有判定)
  → RF-EE → SE-1（メインフロー開始、T3に戻る）
```

---

## 6. BPMN要素の網羅性チェック

### 6.1 出典フローとBPMN要素の対応表

| 出典のフロー要素 | 対応するBPMN要素ID | BPMN要素種別 |
|----------------|-------------------|-------------|
| 🚨 3回ルール | LC-GW1 | 排他ゲートウェイ |
| 🚨 時間ルール | LC-GW2 | 排他ゲートウェイ |
| 🚨 複雑化ルール | LC-GW3 | 排他ゲートウェイ |
| 同じエラーが再発 | LC-GW4 | 排他ゲートウェイ |
| 修正を指示（ループ継続） | LC-T2 | タスク |
| 損切り確定 | LC-EE-CUT | 終了イベント |
| Step 1: 問題の分析（5-10分） | RF-T1, RF-T2, RF-T3 | タスク（3分割） |
| Step 2: アプローチ選択（A/B/C/D） | RF-GW2 | 排他ゲートウェイ |
| A: 人間が直接解決 | RF-T4, RF-T5 | タスク |
| B: 問題を再分解 | RF-T6 | タスク |
| C: コンテキストをリセット | RF-T7 | タスク |
| D: エスカレーション | RF-SP1, RF-T8 | サブプロセス, タスク |
| Step 3: 学びの記録（必須） | RF-T9, RF-T10 | タスク |
| チームで共有（該当する場合） | RF-GW3, RF-T11 | ゲートウェイ, タスク |
| メインフローに戻る（再挑戦） | RF-EE | 終了イベント |
| 🚨 即座にエスカレーション | ES-GW1, ES-T1 | ゲートウェイ, タスク |
| ⚠️ 30分以内にエスカレーション検討 | ES-GW2, ES-T2 | ゲートウェイ, タスク |

### 6.2 T3要素との対応表

| T3の要素ID | T5での扱い |
|-----------|-----------|
| SP3-GW4（損切り判定） | → LC-GW1〜GW4 に詳細分解 |
| SP3-T4（エラー修正指示） | → LC-T2 として再配置 |
| SP3-IE1（30分経過） | → LC-SE への入力トリガーとして維持 |
| SP3-IE2（同一エラー3回目） | → LC-SE への入力トリガーとして維持 |
| SP3-EE-NG（損切り） | → LC-EE-CUT → RF-SE として詳細化 |
| RF-SE〜RF-EE（5要素概要） | → RF-SE〜RF-EE（16要素）に詳細分解 |

---

## 7. BPMN要素の統計

### 7.1 T5で新規定義した要素

| BPMN要素種別 | 個数 | 要素IDの範囲 |
|-------------|------|-------------|
| 開始イベント | 3 | LC-SE, RF-SE, ES-SE |
| 終了イベント | 5 | LC-EE-CONT, LC-EE-CUT, RF-EE, ES-EE-ESC, ES-EE-SELF |
| タスク | 13 | LC-T1〜T2, RF-T1〜T11, ES-T1〜T2 |
| サブプロセス | 1 | RF-SP1 |
| 排他ゲートウェイ (XOR) | 9 | LC-GW1〜GW4, RF-GW1〜GW3, ES-GW1〜GW2 |
| データオブジェクト | 3 | D-6〜D-8（新規）+ D-1, D-5（T3から継続） |

### 7.2 T3+T5の統合要素数

| BPMN要素種別 | T3のみ | T5で追加 | 合計 |
|-------------|-------|---------|------|
| 開始イベント | 6 | 3 | 9 |
| 終了イベント | 10 | 5 | 15 |
| タスク | 25 | 13 | 38 |
| サブプロセス | 3 | 1 | 4 |
| 排他ゲートウェイ (XOR) | 17 | 9 | 26 |
| 中間イベント | 2 | 0 | 2 |
| データオブジェクト | 5 | 3 | 8 |

---

## 検証チェックリスト

- [x] 損切りの4条件（3回/30分/複雑化/再発）がすべてBPMNゲートウェイに対応している
- [x] 損切り判断の結果が2つ（修正継続/損切り確定）に分岐している
- [x] 復帰フロー Step 1（問題の分析）の3ステップがBPMN要素に対応している
- [x] 復帰フロー Step 2（アプローチ選択）の4パターン（A/B/C/D）がBPMN要素に対応している
- [x] 復帰フロー Step 3（学びの記録）がBPMN要素に対応している（必須マーク付き）
- [x] エスカレーション基準（即座/30分以内）がBPMN要素に対応している
- [x] T3の SP3-GW4, SP3-IE1, SP3-IE2 との接続が明示されている
- [x] T3の RF-SE〜RF-EE（概要5要素）を詳細化（16要素）している
- [x] メインフロー SE-1 への復帰パスが示されている
- [x] すべてのBPMN要素に一意のIDが付与されている
- [x] フロー接続関係が明示されている
- [x] データオブジェクト（D-6〜D-8）が定義されている

---

## 出典

- `03-practices.md` — §14. 損切りライン（撤退ルール）、損切り後の復帰フロー、アプローチ選択の判断基準、エスカレーション基準、復帰フロー実践例
- `phase1-t3-bpmn-elements.md` — SP-3（検証フィードバックループ）内の損切り関連要素、§5 復帰フロー概要
- `phase1-t2-dmn-decision-tables.md` — DT-8（協働原則チェック）、DT-9（AI行動原則チェック）参照

---

## スコープ外の提案（参考情報）

以下はT5のスコープ外だが、T6（Mermaid flowchart化）に向けた検討事項として記録：

1. **タイマーイベントの視覚化**: LC-GW2（30分判定）をBPMNの境界タイマーイベントとしてサブプロセスに付加すると、時間経過による強制起動がより明確に表現できる
2. **カウンターの表現**: LC-GW1（3回ルール）のカウンターはBPMN標準では表現しにくいため、データオブジェクトD-6にカウント値を含めることで代替表現可能
3. **日次/週次共有の別フロー化**: RF-T11（チーム共有）の後続として、「💡 日次/週次で共有」のプロセスを独立フローとして定義すると、定期共有のトリガーと内容を明確化できる
4. **復帰フロー実践例のテストケース化**: 出典にある実践例（型エラー3往復→B:再分解→CLAUDE.md追記→再挑戦）を、T7の不変条件検証のテストケースとして活用できる
