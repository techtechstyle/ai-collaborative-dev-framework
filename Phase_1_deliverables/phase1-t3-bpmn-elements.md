# T3: AIファースト実践フローのBPMN要素分解

> **タスク**: AIファースト実践フロー（タスク受領→L0-L3チェック→AIファーストチェック→分業判断→実行→検証）の現状テキストを、BPMN要素に対応付ける
> **検証方法**: すべてのフロー要素がBPMN要素に対応していること
> **自信度**: 確実（プロジェクトドキュメントからの直接抽出・変換）
> **入力**: `00g-ai-first.md`、`01c-task-decomposition.md`、`03-practices.md`、`phase1-t1-decision-conditions.md`、`phase1-t2-dmn-decision-tables.md`

---

## 使用するBPMN要素の凡例

| BPMN要素 | 記号 | 用途 |
|----------|------|------|
| **開始イベント** | ○ | フローの開始点 |
| **終了イベント** | ◎ | フローの終了点 |
| **タスク** | □ | 具体的な作業・処理 |
| **サブプロセス** | □⊞ | 内部に詳細フローを持つ複合タスク |
| **排他ゲートウェイ (XOR)** | ◇ | 条件分岐（1つの経路のみ選択） |
| **並列ゲートウェイ (AND)** | ◇+ | 並列分岐・合流（すべての経路を実行） |
| **中間イベント（エラー）** | ○! | エラー検知イベント |
| **中間イベント（タイマー）** | ○⏱ | 時間条件イベント |
| **データオブジェクト** | 📄 | フロー内で参照・生成される成果物 |

---

## 1. メインフロー: AIファースト実践フロー

> **出典**: `00g-ai-first.md`（AIファースト実践フロー）

### 1.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 | 備考 |
|--------|----------|------|---------------|------|
| **SE-1** | 開始イベント | タスクを受け取る | 「タスクを受け取る」 | フローのエントリーポイント |
| **GW-1** | 排他ゲートウェイ (XOR) | Bright Lines違反チェック | T2: DT-0 | メインフロー進入前の事前チェック |
| **T-1** | タスク | Bright Lines違反を是正する | T2: DT-0 アクション | BL1-BL4違反時の即停止・修正 |
| **SP-1** | サブプロセス | L0-L3チェック | ① L0-L3チェック | 内部に4段階の階層判断を含む（詳細は§2） |
| **GW-2** | 排他ゲートウェイ (XOR) | L0-L3通過判定 | No→「まずL0-L3を満たす形に調整」 | L0-L3のいずれかで不合格の場合分岐 |
| **T-2** | タスク | L0-L3を満たす形に調整する | 「タスク分解、検証基準設定など」 | 調整後はSP-1に戻る |
| **SP-2** | サブプロセス | AIファーストチェック＋分業判断 | ②③ AIファーストチェック→AI初期案生成 | 内部にF1-F4判断を含む（詳細は§3） |
| **GW-3** | 排他ゲートウェイ (XOR) | AIファースト適用判定 | No→「人間主導で進める」 | AI適用可否で分岐 |
| **T-3** | タスク | 人間主導で実行する | 「人間主導で進める（通常フロー）」 | AI不要の場合の実行パス |
| **T-4** | タスク | AIに初期案を生成させる | ③ 「得意な部分をAIに任せる」 | F1-F3適用、F4でプロンプト最適化 |
| **T-5** | タスク | 人間がAI出力をレビューする | ④ 「AIの出力を評価・修正」 | 批判的評価、ビジネス判断、例外処理 |
| **SP-3** | サブプロセス | 検証フィードバックループ | ⑤ 「1文1検証で品質確認」 | 内部に検証・損切り判断を含む（詳細は§4） |
| **GW-4** | 排他ゲートウェイ (XOR) | 検証結果判定 | 検証成功/失敗の分岐 | 失敗時はループまたは損切りへ |
| **EE-1** | 終了イベント | タスク完了 | 「完了」 | 正常終了 |
| **EE-2** | 終了イベント | 損切り後の復帰フローへ | 損切り判断時 | 損切りフロー（§5）へ遷移 |

### 1.2 フロー接続関係

```
SE-1 → GW-1
  GW-1 --[違反あり]-→ T-1 → GW-1（再チェック）
  GW-1 --[違反なし]-→ SP-1
SP-1 → GW-2
  GW-2 --[不合格]-→ T-2 → SP-1（再チェック）
  GW-2 --[合格]---→ SP-2 → GW-3
    GW-3 --[AI不適]-→ T-3 → SP-3
    GW-3 --[AI適用]-→ T-4 → T-5 → SP-3
SP-3 → GW-4
  GW-4 --[成功]-→ EE-1
  GW-4 --[損切り]-→ EE-2
```

---

## 2. サブプロセス SP-1: L0-L3チェック（詳細分解）

> **出典**: `00f-principles.md`（階層判断フロー）、`phase1-t2-dmn-decision-tables.md`（DT-1〜DT-5）

### 2.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 対応する決定表 |
|--------|----------|------|---------------|
| **SP1-SE** | 開始イベント | L0-L3チェック開始 | — |
| **SP1-T1** | タスク | L0 持続可能性チェック | DT-2（G1-G3, R1-R3を評価） |
| **SP1-GW1** | 排他ゲートウェイ (XOR) | L0通過判定 | DT-1 ルール1-2 |
| **SP1-T2** | タスク | L1 心理的安全性チェック | DT-3（P1-P3を評価） |
| **SP1-GW2** | 排他ゲートウェイ (XOR) | L1通過判定 | DT-1 ルール3-4 |
| **SP1-T3** | タスク | L2 急がば回れチェック | DT-4（H1-H3を評価） |
| **SP1-GW3** | 排他ゲートウェイ (XOR) | L2通過判定 | DT-1 ルール5-6 |
| **SP1-T4** | タスク | L3 シンプルさチェック | DT-5（S1-S3を評価） |
| **SP1-GW4** | 排他ゲートウェイ (XOR) | L3通過判定 | DT-1 ルール7-8 |
| **SP1-EE-OK** | 終了イベント | L0-L3全通過 | — |
| **SP1-EE-NG** | 終了イベント | 不合格（調整が必要） | — |

### 2.2 フロー接続関係

```
SP1-SE → SP1-T1 → SP1-GW1
  SP1-GW1 --[No: 持続可能性を損なう]-→ SP1-EE-NG
  SP1-GW1 --[Yes]-→ SP1-T2 → SP1-GW2
    SP1-GW2 --[No: 萎縮の可能性]-→ SP1-EE-NG
    SP1-GW2 --[Yes]-→ SP1-T3 → SP1-GW3
      SP1-GW3 --[No: 丁寧さを保てない]-→ SP1-EE-NG
      SP1-GW3 --[Yes]-→ SP1-T4 → SP1-GW4
        SP1-GW4 --[No: 1文1検証を満たせない]-→ SP1-EE-NG
        SP1-GW4 --[Yes]-→ SP1-EE-OK
```

### 2.3 各タスクの入出力

| タスクID | 入力 | 処理 | 出力 |
|---------|------|------|------|
| SP1-T1 | タスクの内容 | G1-G3, R1-R3の6原則を自問で評価 | 通過/要対応（対応策リスト） |
| SP1-T2 | タスクの内容 | P1-P3の3原則を自問で評価 | 通過/要対応（対応策リスト） |
| SP1-T3 | タスクの内容 | H1-H3の3原則を自問で評価 | 通過/要対応（対応策リスト） |
| SP1-T4 | タスクの内容 | S1-S3の3原則を自問で評価 | 通過/要対応（対応策リスト） |

---

## 3. サブプロセス SP-2: AIファーストチェック＋分業判断（詳細分解）

> **出典**: `00g-ai-first.md`（F1-F4、分業表）、`phase1-t2-dmn-decision-tables.md`（DT-6, DT-7）

### 3.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 対応する決定表 |
|--------|----------|------|---------------|
| **SP2-SE** | 開始イベント | AIファーストチェック開始 | — |
| **SP2-T1** | タスク | タスク特性を分析する | — |
| **SP2-GW1** | 排他ゲートウェイ (XOR) | AIの得意分野か？ | DT-6 入力列「F1判断」 |
| **SP2-T2** | タスク | 分業を決定する（AI主導/人間主導） | DT-6（分業判断） |
| **SP2-GW2** | 排他ゲートウェイ (XOR) | 分業結果の判定 | DT-6 出力列「担当」 |
| **SP2-T3** | タスク | プロンプト技法を選択する | DT-7（F4: 複雑さ・重要度で選択） |
| **SP2-EE-AI** | 終了イベント | AI主導で実行 | DT-6 ルール1-3 |
| **SP2-EE-HM** | 終了イベント | 人間主導で実行 | DT-6 ルール4-5 |

### 3.2 フロー接続関係

```
SP2-SE → SP2-T1 → SP2-GW1
  SP2-GW1 --[No: AI不得意]-→ SP2-EE-HM
  SP2-GW1 --[Yes/不明]-→ SP2-T2 → SP2-GW2
    SP2-GW2 --[人間主導]-→ SP2-EE-HM
    SP2-GW2 --[AI主導]-→ SP2-T3 → SP2-EE-AI
```

### 3.3 タスク特性と分業判断の対応

| タスク特性 | F1-F3判断 | 分業結果 | プロンプト技法 |
|-----------|----------|---------|--------------|
| 初期案・たたき台の作成 | F1: はい | AI主導 | 複雑さに応じてDT-7で選択 |
| スタイル統一・規約遵守 | F2: 一貫性重視 | AI主導 | Zero-shot〜Few-shot |
| 漏れ・抜けの検出 | F3: はい | AI主導 | Chain of Thought |
| 設計判断・アーキテクチャ | F1: いいえ | 人間主導 | — |
| ドメイン固有の判断 | F1: いいえ | 人間主導 | — |

---

## 4. サブプロセス SP-3: 検証フィードバックループ（詳細分解）

> **出典**: `03-practices.md`（§14. 検証フィードバックループ、損切りライン）

### 4.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 |
|--------|----------|------|---------------|
| **SP3-SE** | 開始イベント | 検証開始 | — |
| **SP3-T1** | タスク | typecheck を実行する | 階層的検証: 最速（数秒） |
| **SP3-GW1** | 排他ゲートウェイ (XOR) | typecheck結果判定 | — |
| **SP3-T2** | タスク | lint を実行する | 階層的検証: 高速（数秒〜） |
| **SP3-GW2** | 排他ゲートウェイ (XOR) | lint結果判定 | — |
| **SP3-T3** | タスク | test を実行する | 階層的検証: 中速（数十秒） |
| **SP3-GW3** | 排他ゲートウェイ (XOR) | test結果判定 | — |
| **SP3-T4** | タスク | エラーの修正を指示する | エラーリカバリーパターン |
| **SP3-GW4** | 排他ゲートウェイ (XOR) | 損切り判定 | 損切りライン（3回/30分/複雑化） |
| **SP3-IE1** | 中間イベント（タイマー） | 30分経過 | 「🚨 時間ルール」 |
| **SP3-IE2** | 中間イベント（エラー） | 同一エラー3回目 | 「🚨 3回ルール」 |
| **SP3-T5** | タスク | 協働原則チェック（C1-C4） | DT-8 |
| **SP3-T6** | タスク | AI行動原則チェック（A1-A4） | DT-9 |
| **SP3-EE-OK** | 終了イベント | 検証成功・タスク完了 | — |
| **SP3-EE-NG** | 終了イベント | 損切り → 復帰フローへ | — |

### 4.2 フロー接続関係

```
SP3-SE → SP3-T5（協働原則チェック、並行して監視）
       → SP3-T6（AI行動原則チェック、並行して監視）
       → SP3-T1 → SP3-GW1
  SP3-GW1 --[失敗]-→ SP3-GW4
  SP3-GW1 --[成功]-→ SP3-T2 → SP3-GW2
    SP3-GW2 --[失敗]-→ SP3-GW4
    SP3-GW2 --[成功]-→ SP3-T3 → SP3-GW3
      SP3-GW3 --[失敗]-→ SP3-GW4
      SP3-GW3 --[成功]-→ SP3-EE-OK

SP3-GW4（損切り判定）:
  --[3回未満 AND 30分未満 AND 複雑化していない]-→ SP3-T4 → SP3-T1（再検証）
  --[3回以上 OR 30分超過 OR 複雑化している]---→ SP3-EE-NG

SP3-IE1（30分経過）→ SP3-GW4 を強制起動
SP3-IE2（同一エラー3回目）→ SP3-GW4 を強制起動
```

### 4.3 損切り判定の入力条件

| 条件ID | 条件 | 閾値 | 出典 |
|--------|------|------|------|
| LC-1 | 同一エラーへの往復回数 | 3往復 | 「🚨 3回ルール」 |
| LC-2 | 1つのエラー対応に要した時間 | 30分 | 「🚨 時間ルール」 |
| LC-3 | 修正のたびにコードが複雑化しているか | 定性判断 | 「🚨 複雑化ルール」 |
| LC-4 | 同じエラーが再発しているか | 定性判断 | 「同じエラーが再発」 |

---

## 5. サブプロセス: 損切り後の復帰フロー（参考分解）

> **出典**: `03-practices.md`（損切り後の復帰フロー）
> **備考**: T5で正式にBPMN要素に分解予定。ここではT3との接続点として概要のみ記載。

### 5.1 フロー要素の一覧（概要）

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 |
|--------|----------|------|---------------|
| **RF-SE** | 開始イベント | 損切り発生 | SP3-EE-NG からの遷移 |
| **RF-T1** | タスク | 問題を分析する（5-10分） | Step 1: 問題の分析 |
| **RF-GW1** | 排他ゲートウェイ (XOR) | アプローチ選択 | Step 2: A/B/C/Dの選択 |
| **RF-T2** | タスク | 学びをCLAUDE.mdに記録する | Step 3: 学びの記録（必須） |
| **RF-EE** | 終了イベント | メインフローSE-1に戻る | 再挑戦 |

---

## 6. タスク分解サブプロセス（T-2の詳細）

> **出典**: `01c-task-decomposition.md`（タスク分解の5ステップ、Type分類）

メインフロー T-2「L0-L3を満たす形に調整する」の主な調整手段はタスク分解である。

### 6.1 フロー要素の一覧

| 要素ID | BPMN要素 | 名称 | 出典の対応箇所 |
|--------|----------|------|---------------|
| **TD-SE** | 開始イベント | タスク分解開始 | — |
| **TD-GW1** | 排他ゲートウェイ (XOR) | 「1文1検証」を満たしているか？ | Step 1の前の判定 |
| **TD-T1** | タスク | Step 1: 最終成果物を特定する | 「何が存在しているか？」 |
| **TD-T2** | タスク | Step 2: 依存関係を整理する | 「どの順番で作る必要があるか？」 |
| **TD-T3** | タスク | Step 3: 各成果物を実装単位に分割する | 「さらに小さく分けられるか？」 |
| **TD-T4** | タスク | Step 4: 「1文1検証」単位に調整する | 「検証1回で完了確認できるか？」 |
| **TD-T5** | タスク | Step 5: Type 1/2を判定してラベル付けする | 既存コード参照の有無で判定 |
| **TD-GW2** | 排他ゲートウェイ (XOR) | Type判定 | Type 1 / Type 2 |
| **TD-EE** | 終了イベント | 分解完了（メインフローに戻る） | — |

### 6.2 フロー接続関係

```
TD-SE → TD-GW1
  TD-GW1 --[満たしている]-→ TD-T5 → TD-GW2 → TD-EE
  TD-GW1 --[満たしていない]-→ TD-T1 → TD-T2 → TD-T3 → TD-T4 → TD-T5 → TD-GW2 → TD-EE
```

---

## 7. データオブジェクト（フロー内で参照・生成される成果物）

| データID | 名称 | 生成元 | 参照先 |
|---------|------|--------|--------|
| **D-1** | CLAUDE.md | RF-T2（学び記録時に更新） | SP1-T1〜T4, SP3-T6 |
| **D-2** | タスク一覧（分解後） | TD-T5 | SE-1（再入力） |
| **D-3** | AI出力（初期案） | T-4 | T-5（レビュー対象） |
| **D-4** | 検証結果（typecheck/lint/test） | SP3-T1〜T3 | SP3-GW1〜GW3 |
| **D-5** | 失敗パターン記録 | RF-T2 | D-1（CLAUDE.mdに追記） |

---

## 8. BPMN要素の網羅性チェック

### 8.1 出典フローとBPMN要素の対応表

| 出典のフロー要素 | 対応するBPMN要素ID | BPMN要素種別 |
|----------------|-------------------|-------------|
| タスクを受け取る | SE-1 | 開始イベント |
| L0-L3チェック | SP-1 (SP1-T1〜T4, SP1-GW1〜GW4) | サブプロセス |
| L0-L3を満たす形に調整 | T-2 → TD-* | タスク → サブプロセス |
| AIファーストチェック | SP-2 (SP2-GW1) | サブプロセス |
| 人間主導で進める | T-3 | タスク |
| AI初期案生成（F1-F3, F4） | SP-2 (SP2-T2, SP2-T3) → T-4 | サブプロセス → タスク |
| 人間レビュー | T-5 | タスク |
| 検証（1文1検証） | SP-3 (SP3-T1〜T3) | サブプロセス |
| 検証失敗→修正ループ | SP3-T4 → SP3-T1 | タスク（ループ） |
| 損切り判断 | SP3-GW4, SP3-IE1, SP3-IE2 | ゲートウェイ、中間イベント |
| 完了 | EE-1 | 終了イベント |
| 損切り後の復帰 | EE-2 → RF-* | 終了イベント → サブプロセス |

### 8.2 T2決定表とBPMN要素の対応表

| 決定表 | 対応するBPMN要素 |
|--------|----------------|
| DT-0: Bright Lines事前チェック | GW-1 |
| DT-1: L0-L4階層判断メインフロー | SP-1（サブプロセス全体）+ GW-3 |
| DT-2: L0詳細判断表 | SP1-T1 |
| DT-3: L1詳細判断表 | SP1-T2 |
| DT-4: L2詳細判断表 | SP1-T3 |
| DT-5: L3詳細判断表 | SP1-T4 |
| DT-6: L4分業判断表 | SP2-T2, SP2-GW2 |
| DT-7: プロンプト技法選択表 | SP2-T3 |
| DT-8: 協働原則チェック表 | SP3-T5 |
| DT-9: AI行動原則チェック表 | SP3-T6 |
| DT-10: 競合解決表 | SP1-GW1〜GW4内部で暗黙的に適用 |

---

## 9. BPMN要素の統計

| BPMN要素種別 | 個数 | 要素IDの範囲 |
|-------------|------|-------------|
| 開始イベント | 6 | SE-1, SP1-SE, SP2-SE, SP3-SE, RF-SE, TD-SE |
| 終了イベント | 10 | EE-1, EE-2, SP1-EE-OK, SP1-EE-NG, SP2-EE-AI, SP2-EE-HM, SP3-EE-OK, SP3-EE-NG, RF-EE, TD-EE |
| タスク | 25 | T-1〜T-5, SP1-T1〜T4, SP2-T1〜T3, SP3-T1〜T6, RF-T1〜T2, TD-T1〜T5 |
| サブプロセス | 3 | SP-1, SP-2, SP-3 |
| 排他ゲートウェイ (XOR) | 17 | GW-1〜GW-4, SP1-GW1〜GW4, SP2-GW1〜GW2, SP3-GW1〜GW4, RF-GW1, TD-GW1〜GW2 |
| 中間イベント | 2 | SP3-IE1（タイマー）, SP3-IE2（エラー） |
| データオブジェクト | 5 | D-1〜D-5 |

---

## 検証チェックリスト

- [x] メインフロー（タスク受領→完了）の全ステップがBPMN要素に対応している
- [x] L0-L3チェック（SP-1）の内部フローが分解されている
- [x] AIファーストチェック＋分業判断（SP-2）の内部フローが分解されている
- [x] 検証フィードバックループ（SP-3）の内部フローが分解されている
- [x] 損切りルール（3回/30分/複雑化）がBPMN中間イベント・ゲートウェイに対応している
- [x] 損切り後の復帰フローとの接続点が示されている（T5へ引き継ぎ）
- [x] タスク分解の5ステップがBPMN要素に対応している
- [x] T2の全決定表（DT-0〜DT-10）との対応が示されている
- [x] すべてのBPMN要素に一意のIDが付与されている
- [x] フロー接続関係が明示されている

---

## 出典

- `00g-ai-first.md` — AIファースト実践フロー（メインフロー）、F1-F4、分業表
- `01c-task-decomposition.md` — タスク分解の5ステップ、Type分類、統合判断フロー
- `03-practices.md` — 検証フィードバックループ、損切りライン、復帰フロー、エラーリカバリーパターン
- `phase1-t1-decision-conditions.md` — L0-L4判断条件、Bright Lines
- `phase1-t2-dmn-decision-tables.md` — DT-0〜DT-10（決定表）

---

## スコープ外の提案（参考情報）

以下はT3のスコープ外だが、T4（Mermaid flowchart化）に向けた検討事項として記録：

1. **レーン（スイムレーン）の導入**: 「人間」「AI」「ツール（typecheck/lint/test）」の3レーンに分けることで、各タスクの実行主体を視覚的に明示できる
2. **エラー境界イベントの追加**: SP-1, SP-2の各サブプロセスにエラー境界イベントを付加し、予期しない例外（例：AIの応答不能）への対応パスを明示できる
3. **メッセージフロー**: 人間⇔AI間のやり取り（C1-C4協働原則）をメッセージフローとして表現することで、コミュニケーション要件を可視化できる
